<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Impulse Detroit</title>
    <link href="//fonts.googleapis.com/css?family=Josefin+Sans:400,700" rel="stylesheet" type="text/css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/spectre.css" rel="stylesheet">
    <link href="//vjs.zencdn.net/5.8.8/video-js.css" rel="stylesheet">
    <link href="<%= static_path(@conn, "/css/app.css") %>" rel="stylesheet">
    <!--
    <link href="//cdnjs.cloudflare.com/ajax/libs/foundation/6.3.0/css/foundation-flex.min.css" rel="stylesheet">
    <link href="/css/video-js.min.css" rel="stylesheet">
    -->
  </head>

  <body>
    <main role="main">
      <%= render @view_module, @view_template, assigns %>
    </main>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="<%= static_path(@conn, "/js/app.js") %>"></script>
    <!--
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/foundation/6.3.0/js/foundation.min.js"></script>
    <script src="/js/audioplayer.min.js"></script>
    <script src="/js/foundation.js"></script>
    <script src="/js/video.min.js"></script>
    -->
    <script src="//vjs.zencdn.net/5.8.8/video.min.js"></script>
    <script>
      const node = document.getElementById('elm-main')
          , idapp = Elm.Public.embed(node);

      var audio
        , audioFinder = setInterval(function() {
            audio = document.getElementById('theaudio');
            console.log('looking for audio:', audio);
            if (audio) clearInterval(audioFinder);
          }, 400);

/*
      idapp.ports.init.subscribe((messageFromElm) => {
        $(document).foundation();
      });
      */

      idapp.ports.activateVideo.subscribe((messageFromElm) => {
        videojs.options.flash.swf = '/swf/video-js.swf';

        var tryvideo = setInterval(() => {
          thevideo = document.getElementById('thevideo');
          console.log('trying:', thevideo);
          if (!thevideo) return;

          clearInterval(tryvideo);
          console.log('calling!', thevideo);

          videojs(thevideo, {
            'fluid': true,
            'aspectRatio': '16:9'
          });
        }, 150);
      });

      idapp.ports.playEpisode.subscribe(
        function startEpisode(messageFromElm) {
          setTimeout(function() {
            audio.load();
            //audio.play();
            $('audio').audioPlayer();
/*
            setTimeout(() => {
              //$(() => { $('audio').audioPlayer(); });
            }, 200);
*/
          }, 100);
        }
      );
    </script>
  </body>
</html>
